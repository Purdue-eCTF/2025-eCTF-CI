#!/bin/bash

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 <filename_to_flash>"
  exit 1
fi

BUILD_PATH=$1
# parent directory of update script
CI_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

while true; do
  echo "Putting board in update mode"
  python3 ${CI_DIR}/enable_update.py
  uhubctl -l 1-1 -a cycle > /dev/null 2>/dev/null

  echo -n "Waiting for USB to connect"
  while [ ! -e "/dev/disk/by-label/DAPLINK" ]; do
    echo -n "."
    sleep 1
  done
  python3 ${CI_DIR}/disable_update.py
  echo -e "\nDone!\nFlashing"

  python3 ${CI_DIR}/modified_flash.py $BUILD_PATH /dev/ttyACM0
  if [ "$?" -ne 26 ]; then
    break
  fi
done

sleep 1
echo "Testing with list"
python -m ectf25.tv.list /dev/ttyACM0

echo "Success!"
